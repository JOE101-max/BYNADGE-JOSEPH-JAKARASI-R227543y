 # COHERENCE TOPIC MODELING

print("Generating Embeddings & Topics...")

if time_ok():
    # 1. Embeddings
    embedder = SentenceTransformer("all-MiniLM-L6-v2")
    embeddings = embedder.encode(documents, batch_size=EMBED_BATCH, show_progress_bar=True, convert_to_numpy=True)

    # 2. Clustering (High Coherence Tuning)
    umap_model = UMAP(n_neighbors=15, n_components=5, min_dist=0.0, metric='cosine', random_state=42)
    hdbscan_model = HDBSCAN(min_cluster_size=MIN_CLUSTER_SIZE, metric='euclidean', cluster_selection_method='eom', prediction_data=True)

    topic_model = BERTopic(umap_model=umap_model, hdbscan_model=hdbscan_model, verbose=False)
    topics, _ = topic_model.fit_transform(documents, embeddings)

    # 3. Calculate Coherence
    print("Calculating Coherence Score...")
    try:
        topic_words = [[w[0] for w in topic_model.get_topic(t)] for t in topic_model.get_topic_info()['Topic'] if t != -1]
        tokenized_docs = [d.lower().split() for d in documents]
        dictionary = Dictionary(tokenized_docs)

        cm = CoherenceModel(topics=topic_words, texts=tokenized_docs, dictionary=dictionary, coherence='c_v')
        coherence_score = cm.get_coherence()
        print(f"Final Coherence Score: {coherence_score:.4f}")
    except Exception as e:
        coherence_score = "N/A"
else:
    print("Skipped Topic Modeling due to time constraints.")
    coherence_score = "N/A"
